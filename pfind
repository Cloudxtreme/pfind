#!/usr/bin/perl -w
use strict;
my $state;

sub get_proc_list() {
	my $list = [];
	opendir PROC, "/proc" or die $!;
	while( readdir PROC ) {
		push @$list, $_ if /^\d+$/;
	}
	closedir PROC or die $!;
	return $list;
}

sub check_list($) {
	my $list = shift;
	if( not defined $list ) {
		die "list not defined";
	} elsif( not ref $list ) {
		$list eq "all" or die;
		return( $state->{"all"} //= get_proc_list );
	} elsif( "ARRAY" eq ref $list ) {
		return $list;
	} else {
		die;
	}
}

sub get_exe($) {
	my $pid = shift;
	return( readlink("/proc/$pid/exe") // "" );
}
sub get_cwd($) {
	my $pid = shift;
	return( readlink("/proc/$pid/cwd") // "" );
}
sub get_root($) {
	my $pid = shift;
	return( readlink("/proc/$pid/root") // "" );
}

my %getters = (
	exe	=> \&get_exe,
	cwd	=> \&get_cwd,
	root	=> \&get_root,
);

sub cached_get($$) {
	my ($pid, $name) = @_;
	if( exists $state->{$pid}{$name} ) {
		return $state->{$pid}{$name};
	} elsif( exists $getters{$name} ) {
		return( $state->{$pid}{$name} = $getters{$name}->($pid) );
	} else {
		die "unkown property: $name";
	}
}

sub find_by_prop($$$) {
	my ($list, $re, $name) = @_;
	$list = check_list $list;
	return [ grep { cached_get($_, $name) =~ /$re/ } @$list ];
}

use Data::Dumper; print Dumper find_by_prop "all", "pe", "exe"; ################
use Data::Dumper; print Dumper find_by_prop "all", "/proc/7613", "cwd"; ################
use Data::Dumper; print Dumper $state; ##############
